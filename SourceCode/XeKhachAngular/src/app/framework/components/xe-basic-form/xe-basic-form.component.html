<ng-template #formHeader>
  <div *ngIf="!!formData.header" class="row">
    <div *ngIf="formData.header.profileImage" class="col-sm-3 avatar-holder">
      <img *ngIf="entityUtil.getProfileImageUrl(formData.share.entity, formData.header.profileImage)"
           [alt]="entityUtil.getReadableFieldValue(formData.share.entity, formData.header.titleField)"
           [src]="entityUtil.getProfileImageUrl(formData.share.entity, formData.header.profileImage)"
           class="d-inline border-info rounded-circle avatar w-100">
      <div>
        <button
          *ngIf="!formData.header?.profileImage?.readonly"
          [disabled]="!isIdValid" class="btn btn-sm btn-info camera"
          onclick="this.parentNode?.getElementsByClassName('hidden-input-camera-file')[0].click()">
          <nb-icon icon="camera" pack="fa"></nb-icon>
        </button>
        <input (change)="onProfileImageChange($event.target['files'][0])"
               accept="image/*" class="hidden-input-camera-file"
               hidden
               type="file">
      </div>
    </div>
    <div class="col-sm-9 avatar-content">
      <div class="avatar-title">
        <h4>{{entityUtil.getReadableFieldValue(formData.share.entity, formData.header.titleField)}}</h4>
        {{entityUtil.getReadableFieldValue(formData.share.entity, formData.header.descField)}}
        <ng-container *ngIf="formData.header.subFields">
          <ng-container *ngFor="let field of formData.header.subFields">
            - {{entityUtil.getReadableFieldValue(formData.share.entity, field)}}
          </ng-container>
        </ng-container>
        <ng-content select="[belowHeaderTitle]"></ng-content>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #formTemplate>
  <xe-form #form
           [addToSubmit]="idsIncludeOnSubmit"
           [muteOnSuccess]="formData.control?.muteOnSuccess"
           [readMode]="readMode"
           name="basicFormInfo">
    <div class="row">
      <ng-container *ngFor="let field of filteredField()">
        <div *ngIf="!isHideBody"  class="col-md-{{columnNumber}} pl-4 pr-4">
            <xe-input *ngIf="isIdValid ? !field?.newOnly : true"
                      [(value)]="entityUtil.getFieldOwnerEntity(formData.share?.entity, field)[entityUtil.getLastFieldName(field)]"
                      [disabledUpdate]="field.clearOnSuccess"
                      [grid]="formData.display?.grid"
                      [hidden]="field.hidden"
                      [lblKey]="field.lblKey"
                      [name]="field.name"
                      [required]="field.required"
                      [selectOneMenu]="field.selectOneMenu"
                      [inputMode]="field.mode"
                      [template]="field.template">
            </xe-input>
        </div>
      </ng-container>
    </div>
    <ng-content select="[leftAboveMessageLabel]"></ng-content>
    <lbl #msg class="text-right" p></lbl>
    <div class="float-left">
      <ng-content select="[bottomLeftButtons]"></ng-content>
    </div>
    <div class="float-left">

      <xe-btn (click)="resetHideBody(); form.reset(); screen.go(screens.deleteEntity)"
              *ngIf="(editMode && formData.control?.allowDelete) && isIdValid"
              hideText template="delete"></xe-btn>

      <xe-btn (click)="newEntity(); form.unMute()"
              *ngIf="readMode && formData.control?.allowAdd"
              hideText
              template="add"></xe-btn>
    </div>
    <div class="text-right">
      <ng-content select="[bottomRightButtons]"></ng-content>

      <xe-btn (click)="onCancel()"
              *ngIf="hasDialog || formData.display.cancelBtn === 'close'"
              template="close"></xe-btn>

      <xe-btn (click)="onEdit()"
              *ngIf="readMode"
              template="edit"></xe-btn>

      <ng-container *ngIf="editMode">
        <xe-btn (click)="onCancel()"
                *ngIf="!hasDialog && formData.display.cancelBtn !== 'close'"
                template="cancel"></xe-btn>

        <xe-btn *ngIf="isCreate"
                [disabled]="form.isLoading"
                template="add"></xe-btn>

        <xe-btn *ngIf="isUpdate"
                [disabled]="form.isLoading"
                template="save"></xe-btn>

      </ng-container>
    </div>
  </xe-form>
</ng-template>

<!-- ########################## END OF FORM HEADER #######################-->

<div *ngIf="screen.current === screens.deleteEntity">
  <nb-card>
    <nb-card-header>
      <ng-container [ngTemplateOutlet]="formHeader"></ng-container>
    </nb-card-header>
    <nb-card-body class="text-center">
      <h3>
        <lbl key="ARE_YOU_SURE_TO_DELETE_THIS_DATA"></lbl>
        ?
      </h3>
      <p>
        <lbl key="NOTHING_BE_KEEP"></lbl>
        ...
      </p>
    </nb-card-body>
    <nb-card-footer class="text-center">
      <xe-btn (click)="turnBack()" template="back"></xe-btn>
      <xe-btn (click)="dialog?.close(); deleteCurrentEntity()" template="ok"></xe-btn>
    </nb-card-footer>
  </nb-card>
</div>

<!-- ########################## END OF DELETE DIALOG #######################-->

<ng-container *ngIf="screen.current === screens.form">
  <nb-card *ngIf="!formData.display?.bare">
    <nb-card-header class="{{hideHeader ? 'd-none' : ''}}">
      <ng-content select="[headerTopMost]"></ng-content>
      <ng-container
        [ngTemplateOutlet]="formHeader"></ng-container>
    </nb-card-header>
    <nb-card-body>
      <ng-content select="[bodyTopMost]"></ng-content>
      <ng-container *ngTemplateOutlet="formTemplate"></ng-container>
    </nb-card-body>
  </nb-card>

  <ng-container *ngIf="formData.display?.bare"
                [ngTemplateOutlet]="formTemplate"
  ></ng-container>

</ng-container>
